<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Good Flow</title>
    <!--Favicons made with realfavicongenerator.net-->
    <link rel="apple-touch-icon" sizes="180x180" href="./favicons/apple-touch-icon.png">
    <!--Icons for desktop browsers-->
    <link rel="icon" type="image/png" sizes="32x32" href="./favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicons/favicon-16x16.png">
    <!--Progressive Web App feature settings file-->
    <link rel="manifest" href="./favicons/manifest.json">
    <!--Safary saved/pinned tab icon (svg)-->
    <link rel="mask-icon" href="./favicons/safari-pinned-tab.svg" color="#5bbad5">
    <!--Changes tab color in android chrome-->
    <meta name="theme-color" content="#000000">
    <link rel="stylesheet" href="./sass/css/styles.css">
</head>

<body>

    <div id="canvas_flex">
        <canvas id="viewport" width="500" height="500"></canvas>
    </div>

    <div id="turn">
        <!-- Presents "Turn Screen" upon Portrait orientation -->
        Turn Screen To Play
    </div>

    <div id="cell_container">
        <!-- 2D Matrix of "cell" elements creating the background grid -->
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E="
        crossorigin="anonymous"></script>
    <script src="js/require.js"></script>


    <script>
        require.config({
            baseUrl: './',
            packages: [
                {
                    name: 'physicsjs',
                    location: 'js/physicsjs',
                    main: 'physicsjs-full'
                }
            ],
        });
        require([
            'physicsjs',
            './js/climber',
            './js/climber-behavior'
        ],
            function (Physics) {
                Physics(function (world) {

                    var init = function init(world, Physics) {

                        var width = Math.max($('html').height(), window.innerWidth),
                            height = Math.min($('html').height(), window.innerWidth),
                            unit;
                            climber1 = false;

                        if (width / height <= 1.5) {
                            //scale canvas to the width
                            unit = width / 27;
                            canvasWidth = width,
                            canvasHeight = unit * 18;
                        }
                        else {
                            //scale canvas to the height
                            unit = height / 18,
                            canvasWidth = unit * 27,
                            canvasHeight = height;
                        }

                        var viewportBounds = Physics.aabb(0, 0, canvasWidth, canvasHeight);

                        var edgeBounce = Physics.behavior('edge-collision-detection', {
                            aabb: viewportBounds
                            , restitution: 1
                            , cof: 0
                        });

                        world.add(edgeBounce);

                        var renderer = Physics.renderer('canvas', {
                            el: "viewport", // id of the canvas element
                            autoResize: false,
                            width: canvasWidth,
                            height: canvasHeight,
                            meta: true
                        });
                        world.add(renderer);

                        $('#cell_container').css('top', $('#viewport').position().top).css('left', $('#viewport').position().left).height(18 * unit).width(27 * unit);
                        
                        //add the 27*18 (486) matrix using a DOM element for each cell
                        
                        var cells = []; //need 2d array...

                        for(i = 0; i < 27; i++){
                            var row = [];
                            for(j = 0; j < 18; j++){
                                var cell = $('<span>').addClass('cell').height(unit).width(unit).css('top', j * unit).css('left', i * unit);
                                $('#cell_container').append(cell);
                                row.push(cell);
                            }
                            cells.push(row); //$('<span>')
                        }

                        var i = 2;
                        var circles = [];
                        while (i--) {
                            var plusOrMinus = Math.random() < 0.5 ? -1 : 1;
                            var randomVelocity = Math.random() * .25 - .125; 
                            var circle = Physics.body('circle', {
                                x: Math.random() * canvasWidth
                                , y: Math.random() * canvasHeight
                                , radius: unit / 2 - .5
                                , vx: randomVelocity
                                , vy: (0.0625 - randomVelocity ** 2) ** 0.5 * plusOrMinus
                                , angularVelocity: Math.random() * .02 - .01
                                //, mass: 1
                                , restitution: 1
                                , cof: 0
                                , styles: {
                                    strokeStyle: '#f4356f'
                                    , fillStyle: '#74f442'
                                    , lineWidth: 1
                                    , angleIndicator: '#ff00ff'
                                }
                            });
                            circle.gameType = 'circle';
                            circles.push(circle);
                        }

                        world.add(circles);
                        world.render();

                        world.add([
                            Physics.behavior('body-impulse-response')
                            , Physics.behavior('body-collision-detection')
                            , Physics.behavior('sweep-prune')
                        ]);

                        world.on('step', function () {
                            /*if(climber1){
                                climber1.grow();
                                //console.log(climber1);
                            }*/
                            world.render();
                        });

                        //click event handlers to create climbers, add them to the world over the correct cell
                        $('#viewport').on('click', (e) => {
                            
                            //Figure out which cell was clicked
                            var cell = cells[Math.round(((e.clientX - $('#viewport').position().left) - unit * .5 ) / unit)][Math.round(((e.clientY - $('#viewport').position().top) - unit * .5 ) / unit)];
                            
                            //climbers test
                            climber1 = Physics.body('climber', {
                                x: cell.position().left + unit / 2
                                , y: cell.position().top + unit / 4
                                , height: unit / 2
                                , width: unit
                                , restitution: 1
                                , cof: 0
                                , treatment: 'static'
                                , direction: 'N'
                                , styles: {
                                     fillStyle: 'red'
                                }
                            });
                            /*var climber2 = Physics.body('climber', {
                                x: cell.position().left + unit / 2
                                , y: cell.position().top + unit / 1.3333
                                , height: unit / 2
                                , width: unit
                                , restitution: 1
                                , cof: 0
                                , direction: 'S'
                                , treatment: 'static'
                                , styles: {
                                     fillStyle: 'blue'
                                }
                            });*/
                            
                            var live_climbers = [];
                            // add bodies to the boxes array..
                            live_climbers.push(climber1);

                            // only apply gravity to the bodies in the boxes array
                            var climber_phy = Physics.behavior('climber-behavior')
                                .applyTo(live_climbers);

                            world.add(climber_phy);

                            world.add([climber1/*, climber2*/]);
                            
                            //cell.detach();
                        });

                    }

                    var inGame = false;

                    //Event listener to start new game
                    $(document).on('click touchend', (e) => {
                        if (!inGame && window.innerWidth > window.innerHeight) {
                            document.body.className = 'in-game';
                            inGame = true;
                            newGame();
                        }
                    });

                    var world = null;
                    var newGame = function newGame() {

                        if (world) {
                            world.destroy();
                        }

                        world = Physics(init);
                        world.on('lose-game', function () {
                            document.body.className = 'lose-game';
                            inGame = false;
                        });
                        world.on('win-game', function () {
                            world.pause();
                            document.body.className = 'win-game';
                            inGame = false;
                        });

                    };

                    // subscribe to ticker and start looping
                    Physics.util.ticker.on(function (time) {
                        if (world) {
                            world.step(time);
                        }
                    }).start();

                })
            }

        );
    </script>

</body>

</html>