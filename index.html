<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Good Flow</title>
    <!--Favicons made with realfavicongenerator.net-->
    <link rel="apple-touch-icon" sizes="180x180" href="./favicons/apple-touch-icon.png">
    <!--Icons for desktop browsers-->
    <link rel="icon" type="image/png" sizes="32x32" href="./favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicons/favicon-16x16.png">
    <!--Progressive Web App feature settings file-->
    <link rel="manifest" href="./favicons/manifest.json">
    <!--Safary saved/pinned tab icon (svg)-->
    <link rel="mask-icon" href="./favicons/safari-pinned-tab.svg" color="#5bbad5">
    <!--Changes tab color in android chrome-->
    <meta name="theme-color" content="#000000">
    <link rel="stylesheet" href="./sass/css/styles.css">
</head>

<body oncontextmenu="return false;">

    <div id="canvas_flex">
        <canvas id="viewport" width="500" height="500"></canvas>
    </div>

    <div id="turn">
        <!-- Presents "Turn Screen" upon Portrait orientation -->
        Turn Screen To Play
    </div>

    <div id="cell_container">
        <!-- 2D Matrix of "cell" elements creating the background grid -->
    </div>

    <script src="https://code.jquery.com/jquery-2.2.4.min.js" crossorigin="anonymous"></script>
    <script src="./js/jquery-mobile.js"></script>
    <script src="js/require.js"></script>


    <script>
        require.config({
            baseUrl: './',
            packages: [
                {
                    name: 'physicsjs',
                    location: 'js/physicsjs',
                    main: 'physicsjs-full'
                }
            ],
        });
        require([
            'physicsjs',
            './js/climber',
            './js/climber-behavior'
        ],
            function (Physics) {
                Physics(function (world) {

                    var init = function init(world, Physics) {

                        var width = Math.max($('html').height(), window.innerWidth),
                            height = Math.min($('html').height(), window.innerWidth),
                            climber1,
                            climber2,
                            up_down_dir = true;
                        lvl = 1; //globals
                        self_destruct = false;

                        if (width / height <= 1.5) {
                            //scale canvas to the width
                            unit = width / 27;
                            canvasWidth = width,
                                canvasHeight = unit * 18;
                        }
                        else {
                            //scale canvas to the height
                            unit = height / 18,
                                canvasWidth = unit * 27,
                                canvasHeight = height;
                        }

                        var viewportBounds = Physics.aabb(0, 0, canvasWidth, canvasHeight);

                        var edgeBounce = Physics.behavior('edge-collision-detection', {
                            aabb: viewportBounds
                            , restitution: 1
                            , cof: 0
                        });

                        world.add(edgeBounce);

                        var renderer = Physics.renderer('canvas', {
                            el: "viewport", // id of the canvas element
                            autoResize: false,
                            width: canvasWidth,
                            height: canvasHeight,
                            meta: true
                        });
                        world.add(renderer);

                        $('#cell_container').css('top', $('#viewport').position().top).css('left', $('#viewport').position().left).height(18 * unit).width(27 * unit);

                        //add the 27*18 (486) matrix using a DOM element for each cell

                        cells = [];

                        for (i = 0; i < 27; i++) {
                            var col = [];
                            for (j = 0; j < 18; j++) {
                                var cell = $('<span>').addClass('cell').height(unit).width(unit).css('top', j * unit).css('left', i * unit).data('marked', false);
                                $('#cell_container').append(cell);
                                col.push(cell);
                            }
                            cells.push(col);
                        }

                        var i = 2;
                        var balls = [];
                        while (i--) {
                            var plus_or_minus = Math.random() < 0.5 ? -1 : 1;
                            var random_velocity = Math.random() * .25 - .125;
                            var ball = Physics.body('circle', {
                                x: Math.random() * canvasWidth
                                , y: Math.random() * canvasHeight
                                , radius: unit / 2 - .5
                                , vx: canvasWidth / 1600// random_velocity
                                //, vy: (0.0625 - random_velocity ** 2) ** 0.5 * plus_or_minus
                                , angularVelocity: Math.random() * .02 - .01
                                , mass: 0.001
                                , restitution: 1
                                , cof: 0
                                , styles: {
                                    strokeStyle: '#f4356f'
                                    , fillStyle: 'black'
                                    , angleIndicator: '#ff00ff'
                                }
                            });
                            ball.gameType = 'circle';
                            balls.push(ball);
                        }

                        world.add(balls);
                        world.render();

                        world.add([
                            Physics.behavior('body-impulse-response')
                            , Physics.behavior('body-collision-detection')
                            , Physics.behavior('sweep-prune')
                        ]);

                        world.on('step', function () {
                            world.render();
                        });

                        //switch up_down_dir of climbers
                        $('html').on('mouseup', function (e) {
                            if (e.which == 3) {
                                up_down_dir = !up_down_dir;
                            }
                        });

                        $('html').on('swipe', function () {
                            up_down_dir = !up_down_dir;
                        });

                        //create climbers
                        $('#viewport').on('click', (e) => {

                            //Math which cell was clicked
                            var col = Math.round(((e.clientX - $('#viewport').position().left) - unit * .5) / unit),
                                row = Math.round(((e.clientY - $('#viewport').position().top) - unit * .5) / unit),
                                cell = cells[col][row];

                            if (up_down_dir === true) {

                                if (!world.has(climber1) && row > 0 && ($.contains(document.getElementById('cell_container'), $(cells[col][row - 1])[0]) || !$.contains(document.getElementById('cell_container'), $(cells[col][row + 1])[0]))) {
                                    climber1 = Physics.body('climber', {
                                        x: cell.position().left + unit / 2
                                        , y: cell.position().top + unit / 4 + unit / 2 - 1
                                        , vy: -0.5 / 12
                                        , height: unit / 2
                                        , width: unit - 1
                                        , restitution: 1
                                        , cof: 0
                                        , cell: [col, row]
                                        , treatment: 'dynamic'
                                        , mass: 100000
                                        , dir: 'N'
                                        , styles: {
                                            fillStyle: 'red',
                                            strokeStyle: 'red'
                                        }
                                    });

                                    var climber_phy = Physics.behavior('climber-behavior')
                                        .applyTo([climber1]);
                                    world.addBody(climber1);
                                    world.add(climber_phy);
                                }

                                if (!world.has(climber2) && row < 17 && $.contains(document.getElementById('cell_container'), $(cells[col][row + 1])[0])) {

                                    var y_pos = cell.position().top + unit / 1.3333 + unit / 2 + 1;

                                    if (!$.contains(document.getElementById('cell_container'), $(cells[col][row - 1])[0])) {
                                        y_pos = cell.position().top + unit / 1.3333 - unit / 2 + 1;
                                    }

                                    climber2 = Physics.body('climber', {
                                        x: cell.position().left + unit / 2
                                        , y: y_pos
                                        , vy: .5 / 12
                                        , height: unit / 2
                                        , width: unit - 1
                                        , restitution: 1
                                        , cof: 0
                                        , cell: [col, row + ($.contains(document.getElementById('cell_container'), $(cells[col][row - 1])[0]) ? 1 : 0)]
                                        , treatment: 'dynamic'
                                        , mass: 100000
                                        , dir: 'S'
                                        , styles: {
                                            fillStyle: 'blue',
                                            strokeStyle: 'blue'
                                        }
                                    });

                                    var climber_phy = Physics.behavior('climber-behavior')
                                        .applyTo([climber2]);
                                    world.addBody(climber2);
                                    world.add(climber_phy);
                                }
                            }
                            else {

                                if (!world.has(climber1) && col > 0 && ($.contains(document.getElementById('cell_container'), $(cells[col - 1][row])[0]) || !$.contains(document.getElementById('cell_container'), $(cells[col + 1][row])[0]))) {

                                    climber1 = Physics.body('climber', {
                                        x: cell.position().left - unit / 4 - 1
                                        , y: cell.position().top + unit / 2
                                        , vx: -0.5 / 12
                                        , height: unit - 1
                                        , width: unit / 2
                                        , restitution: 1
                                        , cof: 0
                                        , cell: [col - 1, row] // + ($.contains(document.getElementById('cell_container'), $(cells[col][row - 1])[0]) ? 1 : 0)]
                                        , treatment: 'dynamic'
                                        , mass: 100000
                                        , dir: 'W'
                                        , styles: {
                                            fillStyle: 'yellow',
                                            strokeStyle: 'yellow'
                                        }
                                    });

                                    var climber_phy = Physics.behavior('climber-behavior')
                                        .applyTo([climber1]);
                                    world.addBody(climber1);
                                    world.add(climber_phy);
                                }

                                if (!world.has(climber2) && col < 26 && $.contains(document.getElementById('cell_container'), $(cells[col + 1][row])[0])) {

                                    var x_pos = cell.position().left + unit / 4 + 1;

                                    /*if (!$.contains(document.getElementById('cell_container'), $(cells[col][row - 1])[0])) {
                                        x_pos = cell.position().left + unit / 1.3333 - unit / 2 + 1;
                                    }*/

                                    climber2 = Physics.body('climber', {
                                        x: x_pos
                                        , y: cell.position().top + unit / 2
                                        , vx: .5 / 12
                                        , height: unit - 1
                                        , width: unit / 2
                                        , restitution: 1
                                        , cof: 0
                                        , cell: [col, row] // + ($.contains(document.getElementById('cell_container'), $(cells[col][row - 1])[0]) ? 1 : 0)]
                                        , treatment: 'dynamic'
                                        , mass: 100000
                                        , dir: 'E'
                                        , styles: {
                                            fillStyle: 'green',
                                            strokeStyle: 'green'
                                        }
                                    });

                                    var climber_phy = Physics.behavior('climber-behavior')
                                        .applyTo([climber2]);
                                    world.addBody(climber2);
                                    world.add(climber_phy);
                                }
                            }
                        });
                    }

                    var inGame = false;

                    //Event listener to start new game
                    $(document).on('click touchend', (e) => {
                        if (!inGame && window.innerWidth > window.innerHeight) {
                            document.body.className = 'in-game';
                            inGame = true;
                            newGame();
                        }
                    });

                    var world = null;
                    var newGame = function newGame() {

                        if (world) {
                            world.destroy();
                        }

                        world = Physics(init);

                    };

                    // subscribe to ticker and start looping
                    Physics.util.ticker.on(function (time) {
                        if (world) {
                            world.step(time);
                        }
                    }).start();

                })
            }
        );
    </script>

</body>

</html>